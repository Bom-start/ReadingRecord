## 5장 AOP와 LTW

### 5.1 애스팩트 AOP

#### 프록시 기반 AOP

- AOP는 모듈화된 부가기능과 적용대상의 조합을 통해 여러 오브젝트에 산재해서 나타나는 공통적인 기능을 손쉽게 개발하고 관리할 수 있는 기술
- 객체지향 디자인 패턴의 데코레이터 패턴 또는 프록시 패턴을 응용해서 기존 코드에 영향을 주지 않고 부가기능을 타깃 오브젝트에 제공



#### AOP 개발방법

- AOP의 구성요소를 모두 클래스로 개발하고 이를 빈으로 등록해서 적용

- @AspectJ 애노테이션을 이용해 애스팩트를 만들고 사용

  

#### 수동 프록시 빈

- 스프링 AOP를 사용한다면 모두 프록시 방식의 AOP임
- Client와 Target 클래스가 있고 Client는 Target을 DI 받아 사용하는 관계
- 프록시를 이용해서 Client와 Target의 코드에는 전혀 영향을 주지 않은 채로 Client가 Target을 이용하는 과정에서 부가기능 제공

- Client가 Target을 @Autowired로 직접 DI 하면 안됨 -> client가 Target에 직접 의존하는 대신 Target이 구현하는 인터페이스를 이용해 의존하도록 만들어야
- Client -> Proxy -> Target 순서로 의존관계를 맺으면 Proxy가 Client와 Target의 호출 과정에 끼어 들어서 부가기능 제공



#### 자동 프록시 빈

- 스프링은 자동 프록시 생성기를 이용해서 컨테이너 초기화 중에 만들어진 빈을 바꿔치기해 프록시 빈을 자동으로 등록해줌
- 자동 프록시 생성기가 스프링 프록시 기반 AOP의 핵심 동작 원리
- 프록시를 적용할 대상(Target) 자체를 아예 자신이 포장해서 마치 그 빈처럼 동작하도록 함
- 수동 프록시 빈 방식에서는 Target이라는 클래스 타입의 빈이었지만 자동생성돼서 대체되는 프록시 빈은 Interface 타입이고 Target타입이 아님



#### 프록시의 종류

- 스프링에서는 Client -> Target과 같이 직접적인 의존관계를 만든 경우에도 인터페이스 적용 없이 프록시 적용 가능
- 타깃 클래스 자체를 인터페이스 처럼 사용 -> 타깃 클래스를 상속한 서브클래스를 만들어서 이를 프록시로 사용



#### @AspectJ AOP

- 애스팩트는 그 자체로 애플리케이션의 도메인 로직을 담은 핵심기능은 아니지만, 많은 오브젝트에 걸쳐서 필요한 부가기능을 추상화해놓은 것임
- 애스펙트는 하나 이상의 포인트컷과 어드바이스로 구성됨
- 포인트컷 : @Pointcut  어드바이스 : @Before, @AfterReturning, @AfterThrowing, @After, @Around
- execution(), within(), this,target() 등의 포인트컷 메소드가 있음 



### AspectJ와 @Configurable

#### Aspectj AOP

- 애스펙트 파일을 위한 별도의 컴파일러가 필요하고, 자바클래스에 애스팩트를 적용하는 데도 별도의 재컴파일이 필요
- 별도의 컴파일 과정 없이도 런타임시에 자바 클래스의 바이트코드 조작을 통해 애스펙트를 적용하는 방법 등장
- 스프링 AOP는 DI로 프록시 오브젝트를 추가하면서 애스펙트 적용하였으나 AspectJ는 타깃 오브젝트 자체의 코드를 바꿈
- 프록시를 사용하지 않고 자바 코드에 처음부터 애스펙트가 적용되어 있던 것처럼 클래스 바이트코드를 변경하는 작업 필요
- AsPectJ가 클래스 파일의 바이트코드를 조작을 필요로 하는 이유는 프록시 방식으로는 어드바이스를 적용할 수 없는 조인 포인트와 포인트컷 지시자를 지원하기 위함

- AspectJ를 사용하려면 클래스를 로딩하는 시점에 바이트코드 조작이 가능하도록 로드타임 위버를 적용해줘야 함



#### 로드타임 위버(LTW)

- @Configurable 지원
- 트랜 잭션 AOP 모드를 AspectJ로 설정했을때 필요
- JPA도 로드타임 위버를 이용한 바이트코드 조작 필요



#### @EnableAspectJAutoProxy

- @Aspect로 애스팩를 정의할 수 있게 해주는 @AspectJ AOP 컨테이너 인프라 빈을 등록해줌



#### @EnableLoadTimeWeaving

- 환경에 맞는 로드타임 위버를 등록해줌







