## 6장 테스트 컨텍스트 프레임워크



 ### 6.1 테스트 컨텍스트 프레임워크

- 스프링은 테스트에 사용되는 애플리케이션 컨텍스트를 생성하고 관리하고 테스트에 적용해주는 기능을 가진 테스트 프레임워크를 제공
- 가장 많이 사용되는 테스트 프레임워크는 JUnit 이다.



### 테스트용 애플리케이션 컨텍스트 캐싱과 설정파일

- JUnit4에서는 특정 클래스를 상속하지 않아도 테스트 클래스 작성 가능, @Test만 붙여주면 됨
- 모든 테스트는 서로 영향을 주지 않으며 독립적으로 실행
- but 테스트가 독립적이라고 해서 매번 스프링 컨텍스트, 즉 컨테이너를 새로 만드는 건 매우 비효율적인 방법
- 그래서 스프링은 테스트가 사용하는 컨텍스트를 캐싱해서 여러 테스트에서 하나의 컨텍스트를 공유할 수 있는 방법 제공



#### 컨텍스트 프레임워크 적용방법 

- @RunWith 애노테이션을 이용해서 JUnit 테스트를 실행하는 러너를 스프링이 제공하는 것으로 변경
- 컨텍스트 설정파일 지정, 같은 테스트 클래스안의 테스트 메소드들은 하나의 설정파일로 만들어지는 애플리케이션 컨텍스트를 공유



### 컨텍스트 설정의 상속과 컨텍스트 로더

- Junit장점은 테스트 클래스가 특정 클래스를 상속하도록 강제하지 않음
- 테스트 클래스를 구성할때 필요하면 상속구조 활용
- @ContextConfiguration을 이용해 파일정보 상속



#### 테스트 컨텍스트로부터 DI 받기

- 테스트 클래스는 테스트 컨텍스트로부터 애플리케이션 컨텍스트와 그에 담긴 빈을 DI받아 테스트 코드에서 아용



#### 공유 컨텍스트 사용시 주의 할점

- 캐싱 기법으로 하나의 컨텍스트를 여러 테스트가 공유할 수 있다는것은 테스트 컨텍스트 프레임워크의 단점
- but 컨텍스트를 공유하는 테스트 메소드는 그 구성이나 내부 정보를 함부로 변경해서는 안됨
- 어쩔 수 없이 빈 오브젝트를 조작하거나 수정하는 작업이 필요하면 @DirtiesContext를 사용하자.
- @DirtiesContext는 테스트가 수행되고 나면 현 테스트 컨텍스트를 강제로 제거함



### 6.2 트랜잭션 지원 테스트

- 테스트시 트랜잭션을 조작하거나 지원하는 기능이 필요

#### 트랜잭션 지원이 필요한 이유

- DAO를 개발한 후에 서비스 계층을 거치지 않고 DAO만 테스트해야 할 때가 있음
- 테스트에서 진행되는 모든 DB작업을 하나의 트랜잭션으로 묶어서 진행하고, 테스트를 마칠 때 트랜잭션을 모두 롤백해야 함



#### 트랜잭션 매니저

- 트랜잭션 매니저를 이용해서 트랜잭션 경계를 설정한 후에 DB를 사용하는 빈을 호출해서 테스트 진행
- 테스트가 끝나면 모두 테스트를 실행하기 이전 상태로 rollback 됨



#### @Transactional 테스트

- @Transactional을 사용하여 테스트를 진행하고 강제롤백 옵션이 있어서 테스트 후 원상태로 복구 된다.



#### ORM 롤백 트랜잭션 테스트의 주의사항

- ORM은 모든 작업 결과를 바로 DB에 반영하지 않음, 대신 가능한 한 오랫동안 메모리에 변경사항을 저장하고 있다가 꼭 필요한 시점에서 DB에 반영함을 주의

